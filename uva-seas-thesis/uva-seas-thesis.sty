%% uva-seas-thesis
%%   LaTeX style for writing a Ph.D. (or Masters) thesis for the School of 
%%   Engineering and Applied Science (SEAS) at the University of Virginia.
%% Author: Joel Coffman <jcoffman@cs.virginia.edu>

\def\uvaseasthesis@name{uva-seas-thesis}
\def\uvaseasthesis@version{1.1.15}
\def\uvaseasthesis@modified{2011/01/04} % YYYY/MM/DD (required)

%% =============================================================================
%% CHANGE LOG
%% =============================================================================
%% 0.9.0
%% - Initial version
%% 1.0.3
%% - Readability rewrite
%% - Improved handling of front matter constructs (e.g., signatures page)
%% 1.0.4
%% - Reorganized file structure and additional commenting
%% 1.0.5
%% - Added ams and final options
%% 1.0.6
%% - Added microtype option
%% - Left-justified bibliography
%% 1.1.15
%% - Fixed bug where the acknowledgements (and probably abstract) were numbered
%% - Option for sequential numbering of equations, tables, and figures
%% - Rewrote internals to use newif for option handling
%% =============================================================================

% no idea if the date is correct or not; not even certain how to test on an old 
% version...
\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\ProvidesPackage{\uvaseasthesis@name}[%
    \uvaseasthesis@modified\ UVa SEAS Thesis package by Joel Coffman %
    (v. \uvaseasthesis@version)%
]

%% =============================================================================
%% OPTIONS
%% =============================================================================

%% start options -- listed in alphabetical order
%% ams | noams
\newif\if@uvaseasthesis@ams\relax
\DeclareOption{ams}{
  \@uvaseasthesis@amstrue
}
\DeclareOption{noams}{
  \@uvaseasthesis@amsfalse
}

%% bind | nobind
\newif\if@uvaseasthesis@bind\relax
\DeclareOption{bind}{
  \@uvaseasthesis@bindtrue
}
\DeclareOption{nobind}{
  \@uvaseasthesis@bindfalse
}

%% compliantcopyright
\newif\if@uvaseasthesis@compliantcopyright\relax
\DeclareOption{compliantcopyright}{
  \@uvaseasthesis@compliantcopyrighttrue
}

%% booktabs | nobooktabs
\newif\if@uvaseasthesis@booktabs\relax
\DeclareOption{booktabs}{
  \@uvaseasthesis@booktabstrue
}
\DeclareOption{nobooktabs}{
  \@uvaseasthesis@booktabsfalse
}

%% draft
\newif\if@uvaseasthesis@draft\relax
\DeclareOption{draft}{
  \@uvaseasthesis@drafttrue
}

%% hidefront | hideback | hidefrontback
\newif\if@uvaseasthesis@hidefront\relax
\DeclareOption{hidefront}{
  \@uvaseasthesis@hidefronttrue
}
\newif\if@uvaseasthesis@hideback\relax
\DeclareOption{hideback}{
  \@uvaseasthesis@hidebacktrue
}
\DeclareOption{hidefrontback}{
  \@uvaseasthesis@hidefronttrue
  \@uvaseasthesis@hidebacktrue
}
% NOTE: \if@mainmatter is defined by book.cls for determining if the document is
% in its main matter (verses front or back matter).

%% hyper
\newif\if@uvaseasthesis@hyper\relax
\DeclareOption{hyper}{
  \@uvaseasthesis@hypertrue
}

%% final
\newif\if@uvaseasthesis@final\relax
\DeclareOption{final}{
  \@uvaseasthesis@finaltrue
}

%% microtype | nomicrotype
\newif\if@uvaseasthesis@microtype\relax
\DeclareOption{microtype}{
  \@uvaseasthesis@microtypetrue
}
\DeclareOption{nomicrotype}{
  \@uvaseasthesis@microtypefalse
}

%% openany
\newif\if@uvaseasthesis@openany\relax
\DeclareOption{openany}{
  \@uvaseasthesis@openanytrue
}

%% sequential
\newif\if@uvaseasthesis@sequential\relax
\DeclareOption{sequential}{
  \@uvaseasthesis@sequentialtrue
}

%% twoside
\newif\if@uvaseasthesis@twoside\relax
\DeclareOption{twoside}{
  \@uvaseasthesis@twosidetrue
}
%% end options

%% option handling
% execute `default' options
\ExecuteOptions{ams,booktabs,microtype,nobind}
% process the specified options
%
% \ProcessOptions executes options in the order of declaration; the starred form
% (\ProcessOptions*) executes options in the order specified in the calling 
% command.
\ProcessOptions\relax % \relax avoids unnecessary lookahead due to * form

% NOTE: No packages may be included before \ProcessOptions

%% final
% This final option overrides all others to create a bound version.
\if@uvaseasthesis@final
  \@uvaseasthesis@bindtrue
  \@uvaseasthesis@draftfalse
  \@uvaseasthesis@hidefrontfalse
  \@uvaseasthesis@hidebackfalse
  \@uvaseasthesis@hyperfalse % disable hyper to eliminate (link) colors
  \@uvaseasthesis@openanyfalse
  \@uvaseasthesis@twosidefalse
\fi

%% =============================================================================
%% PACKAGES
%% =============================================================================

%% REQUIRED --------------------------------------------------------------------

% Set appropriate margins. According to UVa Print Services and SEAS, the left 
% margin must be 1.5 inches and the right, top, and bottom margins all 1 inch. 
% No text *except page numbers* should enter the margin.
\RequirePackage[%
    inner=% toward binding (i.e. left unless twoside is specified)
        \if@uvaseasthesis@bind % only use 1.5-inch margin for bound copies
          1.5in %
        \else %
          1in %
        \fi,%
    outer=1in,% away from binding
    top=1in,%
    bottom=1in,%
    % 4 January 2011 - JC
    % By *not* including the header and footer, it is possible to push page 
    % numbers into the page margin (as specified by SEAS). Including additional 
    % text (e.g., the chapter title) in the page header violates the restriction
    % that text should not be printed in the margins.
    %includeheadfoot,% include header and footer in textheight
    asymmetric% twosided layout where margins are *not* swapped on alternate pages
  ]{geometry}

% for capitalizing the first letter of words
\RequirePackage{mfirstuc}

% for double (or other special) spacing
\RequirePackage{setspace}

%% OPTIONAL --------------------------------------------------------------------
%% ams
\if@uvaseasthesis@ams
  \RequirePackage{amsmath}
\fi

%% booktabs
\if@uvaseasthesis@booktabs
  \RequirePackage{booktabs}
\fi

%% draft
\if@uvaseasthesis@draft
  \RequirePackage{type1cm} % arbitrary font size (required by draftwatermark)
  \RequirePackage{draftwatermark} % print watermark across page
  \RequirePackage[pagewise]{lineno} % line numbers (per page)
  
  % line numbers on drafts
  \newif\if@uvaseasthesis@lineno % define new conditional
  \@uvaseasthesis@linenotrue
\fi

%% hyper
\if@uvaseasthesis@hyper
  \RequirePackage[%
      colorlinks=true,% color links instead of using boxes
      linkcolor=red,% color for internal (intra-document) links
      citecolor=green,% color for bibliographic links
      urlcolor=blue,% color for URL links
      hyperfootnotes=false,% disable links to footnotes (because feature is broken)
      hyperindex,% make page numbers in index into hyperlinks
      %implicit=false,% don't redefine LaTeX internals (e.g., \label)
      pdfstartview={FitH},% startup page view: fit width of page to window
      bookmarks
  ]{hyperref}%pdfborder={0 0 0}
  
  % fix problem with hyperref that hyperlinks *below* the caption of floats
  \RequirePackage[all]{hypcap}%
\else
  % hyperref cannot handle fragile commands in moving references (e.g., chapter 
  % or section names). \texorpdfstring allows a TeX and PDF name to be 
  % specified; the PDF name is used by hyperref for link names. Because the 
  % command is not standard, the definition allows its use even when not using 
  % the hyperref package.
  \providecommand{\texorpdfstring}[2]{#1}
\fi

%% microtype
\if@uvaseasthesis@microtype
  \RequirePackage[final]{microtype}
\fi

%% =============================================================================
%% CONFIGURATION
%% =============================================================================

% orphan (i.e., page break immediately after first line of paragraph) penalty
\clubpenalty=10000 % infinite -- no orphans
% widow (i.e., page break immediately before last line of paragraph) penalty
\widowpenalty=10000 % infinite -- no widows

% double space the complete document
\AtBeginDocument{\doublespacing}

% draft watermark
\if@uvaseasthesis@draft
  \SetWatermarkLightness{0.9} % lighten watermark
\fi

% line numbers
\if@uvaseasthesis@lineno
  \AtBeginDocument{\linenumbers} % number lines
\fi

%% =============================================================================

% Counter bug for spacing quotes -- too much whitespace is currently inserted 
% (a blank (doublespaced) line before and after the quote environment).
%
% NOTE that the given code assumes doublespacing is active! Testing the current
% spacing using a macro would be a better solution than hardcoding the value.
\let\oldquote=\quote
\let\endoldquote=\endquote
\renewenvironment{quote}{%
  \vspace{-.5\baselineskip}%
  \begin{oldquote}%
}{%
  \end{oldquote}%
  \vspace{-.5\baselineskip}%
}

%% =============================================================================
%% COMMANDS / ENVIRONMENTS
%% =============================================================================

% NOTE: The starred version of newcommand (and its derivatives) denote commands 
% that will not accept paragraph breaks (e.g., two blank lines raise an 
% immediate error).

% redefine \author to set PDF metadata (if appropriate)
\renewcommand*\author[1]{
  \global\def\@author{#1}
  % set PDF metadata
  \if@uvaseasthesis@hyper
    \hypersetup{pdfauthor = {\@author}}
  \fi
}
% redefine \title to set PDF metadata (if appropriate)
\renewcommand*\title[1]{
  \global\def\@title{#1}
  % set PDF metadata
  \if@uvaseasthesis@hyper
    \hypersetup{pdftitle = {\@title}}
  \fi
}

\newcommand*\degree[1]{\def\graduation@degree{#1}}
\newcommand*\program[1]{\def\graduation@program{#1}}
\newcommand*\documenttype[1]{\def\document@type{#1}}

\newcommand*\graduationmonth[1]{\def\graduation@month{#1}}
\newcommand*\graduationyear[1]{\def\graduation@year{#1}}

% ensure all required information (degree, department (aka "field of study"),
% graduation month, graduation year) has been provided
\AtBeginDocument{%
  \ifx \graduation@degree\undefined 
    \PackageWarning{\uvaseasthesis@name}{%
      missing degree, assuming Ph.D. Use \protect\degree \space in the %
      preamble to specify the degree%
    }
    \degree{Doctor of Philosophy}
  \fi
  \ifx \graduation@program\undefined 
    \PackageError{\uvaseasthesis@name}{%
      missing field of study%
    }{
      Use \protect\program \space in the preamble to specify the field of study.%
    }
  \fi
  \ifx \document@type\undefined
    \def\document@type{thesis}
  \fi
  
  \ifx \graduation@month\undefined
    \PackageError{\uvaseasthesis@name}{%
      graduation month undefined%
    }{%
      Use \protect\graduationmonth \space in the preamble to specify the month %
      of graduation, *not* the defense.%
    }
  \fi
  \ifx \graduation@year\undefined
    \PackageError{\uvaseasthesis@name}{%
      graduation year undefined%
    }{%
      Use \protect\graduationyear \space in the preamble to specify the year %
      of graduation, *not* the defense.%
    }
  \fi
}

\newlength{\hlineheight}
\setlength{\hlineheight}{1pt}

\def\longmonth{Month}
\ifcase\month
  \or\def\longmonth{January}
  \or\def\longmonth{February}
  \or\def\longmonth{March}
  \or\def\longmonth{April}
  \or\def\longmonth{May}
  \or\def\longmonth{June}
  \or\def\longmonth{July}
  \or\def\longmonth{August}
  \or\def\longmonth{September}
  \or\def\longmonth{October}
  \or\def\longmonth{November}
  \or\def\longmonth{December}
\fi
\edef\formatteddate{\number\day\ \longmonth\ \number\year}
\def\today{\formatteddate}

% calculate hour
\newcount\hour
\hour\time\relax
\divide\hour by 60
\edef\hour{\ifnum\hour<10 0\fi\number\hour}

% calculate minute
\newcount\minute
\minute\time\relax
\count255=\hour
\multiply\count255 by 60
\advance\minute by -\count255
\edef\minute{\ifnum\minute<10 0\fi\number\minute}

%\def\meridiem{am}\relax
%\ifnum\hour > 12
%  \advance\hour by -12
%  \def\meridiem{pm}\relax
%\fi

\edef\formattedtime{\hour:\minute}

\edef\timestamp{\formatteddate\ \formattedtime}

%% title page
\renewcommand{\maketitle}{%
  \if@uvaseasthesis@lineno \nolinenumbers \fi % no line numbers
  \begin{titlepage}
    \centering
    
    \vspace*{.5in} % `*' prevents the space from being removed
    \textbf{\Large \@title}\\
    \rule{\textwidth}{\hlineheight}
    A \xmakefirstuc{\document@type}\\
    Presented to\\
    the Faculty of the School of Engineering and Applied Science\\
    University of Virginia\\
    \rule{\textwidth}{\hlineheight}
    In Partial Fulfillment\\
    of the requirements for the Degree\\
    \graduation@degree\ (\graduation@program)\\[4ex]
    by\\[3ex]
    \@author\\
    \graduation@month\ \graduation@year\\
    
    \if@uvaseasthesis@draft
      \vfill
      
      \hrule
      \begin{center}
        DRAFT: \timestamp
      \end{center}
      \hrule
    \fi
  \end{titlepage}
  
  \thispagestyle{empty} % \endtitlepage => \cleardoublepage, ensure blank
  \if@uvaseasthesis@lineno \linenumbers \fi % re-enable line numbers
}

%% copyright page
\DeclareRobustCommand{\copyrightpage}{
  \thispagestyle{empty} % no header or footer
  \if@uvaseasthesis@hidefront
  \else
    \if@uvaseasthesis@lineno \nolinenumbers \fi % no line numbers
    
    % 14 August 2010 - JC
    % \singlespacing interferes with \begingroup and \centering, but 
    % \begin{center} has the desired effect
    \begin{center}
      \singlespacing
      
      \ \vfill
      
      % copyright block specified by UVa print services
      \if@uvaseasthesis@compliantcopyright
        \noindent\textcopyright\ Copyright by\\
        \@author\\
        All rights reserved\\
        \graduation@month\ \graduation@year\\
      \else % more traditional copyright notice
        \textcopyright\ \graduation@year\ by \@author
      \fi
    \end{center}
    
    \clearpage
    \if@uvaseasthesis@lineno \linenumbers \fi % re-enable line numbers
  \fi
}

%% signatures page
\newcommand{\signaturestyle}[1]{}
\def\signatures{%
  \begingroup
    % \newcommand is local within a group
    \newcommand{\signature}[2][]{}
    \newcommand{\dean}[1]{}
    
    \if@uvaseasthesis@hidefront
    \else
      \if@uvaseasthesis@lineno \nolinenumbers \fi
      \thispagestyle{plain} % page number in footer
      
      \section*{\centering\Large Approval Sheet}
      
      \begin{center}
        This \document@type\ is submitted in partial fulfillment of the requirements for the degree of\\
        \graduation@degree\ (\graduation@program)
      \end{center}
     
      \newlength{\signaturewidth}
      \setlength{\signaturewidth}{.8\textwidth}
      
      \newlength{\signaturesize}
      \setlength{\signaturesize}{30pt}
      
      \newcommand{\signaturespace}{\vspace{\signaturesize}}
      \newcommand{\signatureindent}{\par\noindent\hspace{.2\textwidth}}
      
      \newcommand{\signatureline}[1][]{%
        \signaturespace%
        \signatureindent%
        \if@uvaseasthesis@final %
        \else %
          \makebox[0em][l]{%
            \makebox[\signaturewidth][c]{%
              \raisebox{.5em}[0pt][0pt]{%
                \signaturestyle{##1}%
              }%
            }%
          }%
        \fi%
        \rule{\signaturewidth}{\hlineheight}
      }
      
      \renewcommand{\signature}[2][]{\signatureline[##1]\signatureindent##2}
      \renewcommand{\dean}[1]{\def\@dean{##1}}
      
      \singlespacing
      
      \signature[\@author]{\@author}
      
      \addvspace{.75\signaturesize}
      \noindent This \document@type\ has been read and approved by the Examining Committee:
  \fi
}
\def\endsignatures{%
  \if@uvaseasthesis@hidefront
  \else
      \singlespacing
      
      \addvspace{.75\signaturesize}
      \noindent Accepted for the School of Engineering and Applied Science:
      
      \signature[\ifx\@dean\undefined\else\@dean\fi]{Dean\ifx\@dean\undefined \else\ \@dean\fi, School of Engineering and Applied Science}
    
    \begin{center}
      \graduation@month\ \graduation@year
    \end{center}
    
    \clearpage
    \if@uvaseasthesis@lineno \linenumbers \fi
  \fi
  \endgroup
}

\DeclareRobustCommand{\dedication}[1]{%
  \if@uvaseasthesis@hidefront
  \else
    \thispagestyle{plain} % page number in footer
    
    \begingroup
      \centering
      \if@uvaseasthesis@lineno \nolinenumbers \fi % no line numbers, ends at end of group
      
      \ \vfill
      \emph{#1}
      \vfill
    \endgroup
    
    \clearpage
  \fi
}

%% abstract
%
% 4 January 2011 - JC
% According to UVa Print Services's dissertation checklist, the abstract must 
% be 350 words or less. Enforcing this requirement is not possible using LaTeX.
\newenvironment{abstract}[0]{%
  \renewcommand{\chaptermark}[1]{\markboth{##1}{##1}}%
  \chapter*{Abstract}%
}{
  \clearpage%
  \chaptermark{}%
}

%% acknowledgments
\newenvironment{acknowledgments}[0]{%
  \renewcommand{\chaptermark}[1]{\markboth{##1}{##1}}%
  \chapter*{Acknowledgments}%
}{%
  \clearpage%
  \chaptermark{}%
}

% tableofcontents
%
% Since the "standard" bibliography command uses \MakeUppercase, the simplest 
% way to print in mixed case is by making \MakeUppercase a no-op.
%
% Note that this redefinition is repeated for the table of contents, list of 
% tables, list of figures, and bibliography itself.
\let\@oldtableofcontents\tableofcontents
\renewcommand{\tableofcontents}{%
  \if@uvaseasthesis@hidefront
  \else
    \if@uvaseasthesis@hyper \phantomsection \fi
    \addcontentsline{toc}{chapter}{Contents}
    
    \begin{singlespace}
      \renewcommand{\MakeUppercase}[1]{##1}
      
      \@oldtableofcontents
    \end{singlespace}
  \fi
}

% listoftables
\let\@oldlistoftables\listoftables
\renewcommand{\listoftables}{%
  \if@uvaseasthesis@hidefront
  \else
    \clearpage
    \if@uvaseasthesis@hyper \phantomsection \fi
    \addcontentsline{toc}{section}{List of Tables}
    
    \begin{singlespace}
      \renewcommand{\MakeUppercase}[1]{##1}
      
      \@oldlistoftables
    \end{singlespace}
  \fi
}

% listoffigures
\let\@oldlistoffigures\listoffigures
\renewcommand{\listoffigures}{%
  \if@uvaseasthesis@hidefront
  \else
    \clearpage
    \if@uvaseasthesis@hyper \phantomsection \fi
    \addcontentsline{toc}{section}{List of Figures}
    
    \begin{singlespace}
      \renewcommand{\MakeUppercase}[1]{##1}
      
      \@oldlistoffigures
    \end{singlespace}
  \fi
}

% bibliography
\bibliographystyle{unsrt}

\let\@oldbibliography\bibliography\relax
\renewcommand{\bibliography}[1]{%
  \if@uvaseasthesis@hideback
  \else
    \if@uvaseasthesis@hyper \phantomsection \fi
    \addcontentsline{toc}{chapter}{Bibliography}
    
    \begingroup
      \raggedright
      \singlespacing
      
      \setlength{\parskip}{\baselineskip}
      
      \renewcommand{\MakeUppercase}[1]{##1}
      \@oldbibliography{#1}
    \endgroup
  \fi
}

% header / footer
\def\ps@myheadings{%
  \def\@oddhead{\rightmark\hfill\thepage}%
  \def\@evenhead{%
      \if@uvaseasthesis@twoside %
        \thepage\hfill %
      \fi %
      \leftmark %
      \if@uvaseasthesis@twoside %
      \else %
        \hfill\thepage %
      \fi%
  }%
  \def\@oddfoot{%
      \if@uvaseasthesis@draft %
        \hfill DRAFT: \timestamp \hfill %
      \fi%
  }%
  \def\@evenfoot{%
      \if@uvaseasthesis@draft %
        \hfill DRAFT: \timestamp \hfill %
      \fi%
  }%
}
\pagestyle{myheadings}

\renewcommand{\chaptermark}[1]{%
  \markboth{Chapter \thechapter\hspace{1em}\vrule\hspace{1em}#1}{Chapter \thechapter\hspace{1em}\vrule\hspace{1em}#1}
}
\renewcommand{\sectionmark}[1]{
  \markright{\thesection\hspace{1em}\vrule\hspace{1em}#1}
}

\pagenumbering{alph}

\let\@oldfrontmatter\frontmatter\relax
\DeclareRobustCommand{\frontmatter}{%
  \@oldfrontmatter%
  \pagenumbering{roman}%
}

\let\@oldmainmatter\mainmatter\relax
\DeclareRobustCommand{\mainmatter}{%
  \@oldmainmatter%
  \pagenumbering{arabic}%
}

% sequential numbering (of tables, figures, equations, etc.)
%
% 4 January 2010 - JC
% Sequential numbering (throughout chapter) of equations, tables, and figures. 
% Documentation is practically non-existent regarding LaTeX's internal handling 
% of counters, but the following appears to work.
\if@uvaseasthesis@sequential
  \newcounter{sequential}[chapter]
  
  \let\c@equation=\c@sequential\relax
  \let\c@figure=\c@sequential\relax
  \let\c@table=\c@sequential\relax
  
  % explicitly support the listings package
  \@ifpackageloaded{listings}{%
    \let\c@lstnumber=\c@sequential\relax
  }
\fi